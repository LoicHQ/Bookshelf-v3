---
description: Agent spÃ©cialisÃ© Base de donnÃ©es pour BookShelf
globs:
  - "**/prisma/**"
  - "**/*.prisma"
  - "**/migrations/**"
  - "**/src/lib/prisma.ts"
  - "**/src/lib/supabase.ts"
  - "**/prisma.config.ts"
alwaysApply: false
---

# ğŸ—„ï¸ Agent Base de DonnÃ©es - BookShelf

Tu es un expert en modÃ©lisation de donnÃ©es pour **BookShelf**. Tu connais parfaitement le schÃ©ma Prisma existant et les relations entre les modÃ¨les.

## Stack technique

- **ORM** : Prisma 7.2
- **Database** : PostgreSQL (Supabase)
- **Client** : @prisma/client
- **Config** : prisma.config.ts

## SchÃ©ma existant (prisma/schema.prisma)

### ModÃ¨les principaux

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      User       â”‚     â”‚       Book        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (cuid)       â”‚     â”‚ id (cuid)         â”‚
â”‚ username        â”‚     â”‚ name              â”‚
â”‚ email (unique)  â”‚     â”‚ subtitle          â”‚
â”‚ password        â”‚     â”‚ isbn (unique)     â”‚
â”‚ templateId      â”‚     â”‚ isbn13            â”‚
â”‚ createdAt       â”‚     â”‚ author            â”‚
â”‚ updatedAt       â”‚     â”‚ authors[]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ description       â”‚
         â”‚              â”‚ coverImage        â”‚
         â”‚              â”‚ thumbnail         â”‚
         â”‚              â”‚ publishedDate     â”‚
         â”‚              â”‚ publisher         â”‚
         â”‚              â”‚ pageCount         â”‚
         â”‚              â”‚ categories[]      â”‚
         â”‚              â”‚ language          â”‚
         â”‚              â”‚ series            â”‚
         â”‚              â”‚ seriesNumber      â”‚
         â”‚              â”‚ averageRating     â”‚ â† Google Books
         â”‚              â”‚ ratingsCount      â”‚ â† Google Books
         â”‚              â”‚ maturityRating    â”‚ â† Google Books
         â”‚              â”‚ printType         â”‚ â† Google Books
         â”‚              â”‚ previewLink       â”‚ â† Google Books
         â”‚              â”‚ infoLink          â”‚ â† Google Books
         â”‚              â”‚ googleBooksId     â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚   â”‚
               â”Œâ”€â”€â–¼â”€â”€â”€â–¼â”€â”€â”
               â”‚ UserBook â”‚  (table pivot)
               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
               â”‚ id       â”‚
               â”‚ userId   â”‚
               â”‚ bookId   â”‚
               â”‚ rating   â”‚  1-5 Ã©toiles
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ModÃ¨les sociaux

```
User â”€â”€â”¬â”€â”€ ChatRoomMember â”€â”€â”€â”€ ChatRoom
       â”‚                          â”‚
       â””â”€â”€ Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User â”€â”€ UserWidget (widgets du dashboard)
```

### ModÃ¨les NextAuth

```
User â”€â”€ Account (OAuth providers)
     â”€â”€ Session
VerificationToken (standalone)
```

## Index existants

```prisma
@@index([userId])    // Sur UserBook, ChatRoomMember, Message, UserWidget
@@index([bookId])    // Sur UserBook
@@index([status])    // Sur UserBook
@@index([chatRoomId])// Sur ChatRoomMember, Message
```

## Commandes Prisma

```bash
# DÃ©veloppement
pnpm db:generate    # GÃ©nÃ©rer le client Prisma
pnpm db:push        # Push le schÃ©ma sans migration
pnpm db:migrate     # CrÃ©er une migration
pnpm db:studio      # Ouvrir Prisma Studio

# Production
prisma generate && prisma migrate deploy
```

## Patterns de requÃªtes BookShelf

```typescript
// RÃ©cupÃ©rer les livres d'un utilisateur avec le livre associÃ©
const userBooks = await prisma.userBook.findMany({
  where: { userId: session.user.id },
  include: { book: true },
  orderBy: { updatedAt: 'desc' },
});

// Statistiques de lecture
const stats = await prisma.userBook.groupBy({
  by: ['status'],
  where: { userId: session.user.id },
  _count: true,
});

// Recherche de livre par ISBN (cache local avant API externe)
const existingBook = await prisma.book.findFirst({
  where: {
    OR: [
      { isbn: isbnQuery },
      { isbn13: isbnQuery },
    ],
  },
});
```

## Ã‰volutions futures suggÃ©rÃ©es

- [ ] `ReadingGoal` : Objectifs de lecture annuels
- [ ] `BookList` : Listes personnalisÃ©es (PAL, wishlist)
- [ ] `Review` : Critiques publiques sÃ©parÃ©es des notes privÃ©es
- [ ] `Follow` : SystÃ¨me d'abonnement entre utilisateurs
- [ ] `Notification` : Notifications in-app
